---
title: "STA610 Case Study 1"
author: "Emily Gentles, Weiyi Liu, Jack McCarthy, Qinzhe Wang"
date: "9/24/2021"
output: pdf_document
---

```{r setup, include=FALSE, message=FALSE}
library(tidyverse)
library(janitor)
library(gridExtra)
library(cowplot)

knitr::opts_chunk$set(echo=FALSE, warning=FALSE)
```

```{r}
load('streetrx.RData')

# subset for group drug
morph_data <- streetrx %>%
  drop_na() %>%
  clean_names() %>%
  filter(api_temp == 'morphine')
```

# Introduction

# EDA

### Response Distribution

First, a look at the distributions of the response variable "ppm". Observations 
with ppm between the 0.1 and 99.9 percentiles were considered so as to avoid 
the influence of extreme outliers on the analysis of the ppm distribution.

```{r, fig.width=10, fig.height=3.5}
morph_trunc <- morph_data %>%
  filter(between(ppm, quantile(ppm, 0.001), quantile(ppm, 0.999)))

p1 <- morph_trunc %>%
  ggplot(aes(x=ppm)) +
    geom_histogram(
      aes(y=..density..), 
      color='black', 
      linetype='dashed',
      size=0.5,
      fill='lightblue', 
      alpha=0.5,
      bins=20
    ) +
    geom_density(size=0.75, bw=0.3) +
    labs(title='Distribution of morphine ppm') +
    theme_classic()

p2 <- morph_trunc %>%
  ggplot(aes(x=log(ppm))) +
    geom_histogram(
      aes(y=..density..), 
      color='black', 
      linetype='dashed',
      size=0.5,
      fill='lightcoral', 
      alpha=0.5,
      bins=20
    ) +
    geom_density(size=0.75, bw=0.3) +
    labs(title='Distribution of morphine log(ppm)') +
    xlim(-7, 3) +
    theme_classic()

grid.arrange(p1, p2, ncol=2)
```

The distribution of ppm is clearly right-skewed, and it is strictly nonnegative 
in value, so a log transformation may be appropriate. The distribution of 
log(ppm) is given above, and appears closer to the desired normal.

### Predictor-Response Relationships

Next we may look at the relationship between state and log(ppm).

```{r, fig.width=10, fig.height=3}
morph_state <- morph_trunc %>%
  filter(state %in% state.name) %>%
  mutate(state_abv=state.abb[match(state,state.name)])

grand_mean <- mean(morph_state$ppm)

p3 <- morph_state %>%
  group_by(state_abv) %>%
  summarise(n = n(), mean = mean(ppm)) %>%
  ggplot(aes(x=n, y=mean)) +
    geom_hline(
      aes(yintercept=grand_mean),
      linetype='dashed',
      color='red',
      size=0.75
    ) +
    geom_point() +
    labs(x='sample size', y='mean ppm') +
    theme_classic()

p4 <- morph_state %>%
  ggplot(aes(y=log(ppm), x=state_abv)) +
    geom_boxplot(
      fill=rainbow(50),
      alpha=0.5    
    ) +
    scale_x_discrete(guide=guide_axis(angle = 90)) +
    theme_classic() +
    labs(x='state')

plot_grid(p3, p4, ncol=2, rel_widths=c(0.275, 0.725))
```

We observe that the within-state means for states with higher sample sizes in 
general adhere more closely to the grand mean. It is also evident that the log(ppm) 
distributions differ little as compared to the within-state variance. This is 
conducive to the borrowing of information between states.